---
title: "P Change Research"
author: "Zehao Qian"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Data Set: Simulation 1 and 6

-   N = 1000

-   p = 0.01, 0.02, 0.03

-   q = 0.3

-   Iteration = 25

```{r}
# --------------------------------------------------------
gc()
rm(list = ls())
graphics.off()
cat("\014")
# --------------------------------------------------------
folder_name <- "./pic_p_change_research"
if (dir.exists(folder_name)) {
  unlink(folder_name, recursive = TRUE)
}
dir.create(folder_name)
```

```{r}
library(data.table)
simulation1_results = fread("./report/simulation1.csv")
```

```{r}
library(tidyr)
library(dplyr)

p.change.research = simulation1_results %>%
  filter(AgentID == 100, Step == 100)

data.p.change.long <- p.change.research %>%
  pivot_longer(cols = starts_with("Steps_to"), 
               names_to = "Step_Percent", 
               values_to = "Steps_Count") %>%
  mutate(p_number = case_when(
    p == 0.01 ~ "p = 0.01",
    p == 0.02 ~ "p = 0.02",
    p == 0.03 ~ "p = 0.03",
    TRUE ~ NA_character_  # other cases
  ))

```

```{r fig.height=8, fig.width=12}
library(ggplot2)

box = ggplot(data.p.change.long) +
  aes(x = p_number, y = Steps_Count, fill = p) +
  geom_boxplot() +
  scale_fill_gradient() +
  labs(
    x = "Different P Number",
    y = "Steps Count",
    title = "Boxplot for Potential User Acceptance Ratio",
    subtitle = "When the acceptance probability of innovator changes (p)"
  ) +
  theme_light() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  facet_wrap(vars(Step_Percent))

ggsave("./pic_p_change_research/box.png",
       plot = box,
       device = "png",
       height = 8,
       width = 12)

box

```

```{r}
line.data = simulation1_results %>%
  filter(AgentID == 0)
```

```{r}
# calculate the max, min and mean value of Adopted_Count for each step and p's combination
ribbon_data <- line.data %>%
  group_by(Step, p) %>%
  summarise(
    ymin = min(Adopted_Count),
    ymax = max(Adopted_Count),
    y_mean = mean(Adopted_Count)
  )
```

```{r fig.height=6, fig.width=10}
# create Ribbon Plot
ribbon <- ggplot(ribbon_data) +
  aes(x = Step, ymin = ymin, ymax = ymax) +
  geom_ribbon(alpha = 0.3, fill = "blue") +  # add ribbon
  geom_line(aes(y = y_mean), color = "red") +  # add a line of average value
  labs(
    x = 'Steps Count',
    y = 'Adopted User Count',
    title = "Ribbon Chart Comparison with Different P Value", 
    subtitle = "N=1000, iteration=25"
  ) +
  theme_light() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  facet_wrap(vars(p))

ggsave("./pic_p_change_research/ribbon.png",
       plot = ribbon,
       device = "png",
       height = 6,
       width = 10)

# show the plot
ribbon
```

```{r fig.height=6, fig.width=10}
line = ggplot(line.data) +
  aes(
    x = Step,
    y = Adopted_Count,
    colour = RunId,
    group = RunId
  ) +
  geom_point(size = 1.6, shape = "circle small") +
  scale_color_viridis_c(option = "magma", direction = 1) +
  labs(
    x = 'Steps Count',
    y = 'Adopted User Count',
    title = "Line Chart Comparison with Different P Value", subtitle = "N=1000, iteration=25") +
  theme_light() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  facet_wrap(vars(p))

ggsave("./pic_p_change_research/line.png",
       plot = line,
       device = "png",
       height = 6,
       width = 10)

# Show the plot
line
```

```{r fig.height=6, fig.width=10}

# create a combined-plot with both scatter and ribbon plot
combined_plot <- ggplot() +
  geom_ribbon(
    data = ribbon_data,
    aes(x = Step, ymin = ymin, ymax = ymax),
    alpha = 0.3,
    fill = "blue"
  ) +
  geom_line(
    data = ribbon_data,
    aes(x = Step, y = y_mean),
    color = "red",
    size = 1.5
  ) +
  geom_point(
    data = line.data,
    aes(x = Step, y = Adopted_Count, colour = RunId),
    size = 1.6,
    shape = "circle small"
  ) +
  scale_color_viridis_c() +
  labs(
    x = 'Steps Count',
    y = 'Adopted User Count',
    title = "Ribbon and Scatter Plot Comparison with Different P Value",
    subtitle = "N=1000, iteration=25"
  ) +
  theme_light() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) +
  facet_wrap(vars(p))

ggsave("./pic_p_change_research/combined_plot.png",
       plot = combined_plot,
       device = "png",
       height = 6,
       width = 10)

combined_plot
```

```{r}

```
